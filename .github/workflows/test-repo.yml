# Workflow to test the oolite-msys2 repository

# This workflow is can be triggered by a workflow_call event when called by other workflows.
# It can also be called by a workflow_dispatch event from GitHub.

# The workflow currently contains one job:
# - shellcheck: Runs ShellCheck to check all the bash scripts

# TODO
# Add jobs to test the workflow actions.

name: Test repository
on:
  workflow_call:
  workflow_dispatch:
permissions:
  contents: read
jobs:

########################################
########################################
########################################

# Run Shellcheck to lint the scripts

  shellcheck:
    name: Run ShellCheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v5

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master

########################################
########################################
########################################

# Test cache-built-dependency action

# Need to check what happens if the path does not exist
# Need to check what happens if the path is empty
# Need to check what happens if the path is not a directory
# Need to check what happens if the key is empty

# Need to check what happens if we want to delete the cache
# Need to check that the caching is successful

########################################
########################################
########################################

# Test early-exit-if-cache-exists action

# Need to check all inputs
# Need to check all outputs
# Need to check early exit

########################################
########################################
########################################

# Test extract-data-string-from-file action

  test-extract-data-string-from-file:
    name: Test extract-data-string-from-file action
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
#    env:
#      TESTING_MODE: true

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      # Tests expected to succeed

      - name: Test - Extracting a single word from a file
        id: extract-data-single-word
        if: always()
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ./.github/actions/extract-data-string-from-file/test/single-word

      - name: Result - Extracting a single word from a file
        id: extract-data-single-word-result
        if: always()
        run: |
          echo "Extracted data is: '${{ steps.extract-data-single-word.outputs.data }}'"
          if [[ "${{ steps.extract-data-single-word.outputs.data }}" != "foo" ]]; then
            echo "Extracted data is not 'foo'"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Test - Extracting multiple words from a file
        id: extract-data-multiple-words
        if: always()
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ./.github/actions/extract-data-string-from-file/test/multiple-words

      - name: Result - Extracting multiple words from a file
        id: extract-data-multiple-words-result
        if: always()
        run: |
          echo "Extracted data is: '${{ steps.extract-data-multiple-words.outputs.data }}'"
          if [[ "${{ steps.extract-data-multiple-words.outputs.data }}" != "foo bar" ]]; then
            echo "Extracted data is not 'foo bar'"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Test - Extracting multiple lines from a file
        id: extract-data-multiple-lines
        if: always()
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ./.github/actions/extract-data-string-from-file/test/multiple-lines

      - name: Result - Extracting multiple lines from a file
        id: extract-data-multiple-lines-result
        if: always()
        run: |
          echo "Extracted data is: '${{ steps.extract-data-multiple-lines.outputs.data }}'"
          if [[ "${{ steps.extract-data-multiple-lines.outputs.data }}" != $'foo\nbar' ]]; then
            echo "Extracted data is not $'foo\nbar'"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Test - Extracting an empty file
        id: extract-data-empty
        if: always()
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ./.github/actions/extract-data-string-from-file/test/empty

      - name: Result - Extracting an empty file
        id: extract-data-empty-result
        if: always()
        run: |
          echo "Extracted data is: '${{ steps.extract-data-empty.outputs.data }}'"
          if [[ "${{ steps.extract-data-empty.outputs.data }}" != "" ]]; then
            echo "Extracted data is not ''"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Test - Extracting a file with spaces
        id: extract-data-spaces
        if: always()
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ./.github/actions/extract-data-string-from-file/test/spaces

      - name: Result - Extracting a file with spaces
        id: extract-data-spaces-result
        if: always()
        run: |
          echo "Extracted data is: '${{ steps.extract-data-empty.outputs.data }}'"
          if [[ "${{ steps.extract-data-empty.outputs.data }}" != "" ]]; then
            echo "Extracted data is not ''"
            exit 1
          else
            echo "Test successful"
          fi

      # Tests expected to fail

      - name: Test - Extracting from a non-existent file
        id: extract-non-existent-file
        if: always()
        continue-on-error: true
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ./.github/actions/extract-data-string-from-file/test/non-existent-file

      - name: Result - Extracting from a non-existent file
        id: extract-non-existent-file-result
        if: always()
        run: |
          echo "Action error is: '${{ steps.extract-non-existent-file.outputs.error }}'"
          if [[ "${{ steps.extract-non-existent-file.outputs.error }}" != "Path does not exist" ]]; then
            echo "Action error is not 'Path does not exist'"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Test - Extracting from a directory
        id: extract-directory
        if: always()
        continue-on-error: true
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ./.github/actions/extract-data-string-from-file/test/

      - name: Result - Extracting from a directory
        id: extract-directory-result
        if: always()
        run: |
          echo "Action error is: '${{ steps.extract-directory.outputs.error }}'"
          if [[ "${{ steps.extract-directory.outputs.error }}" != "Path is a directory" ]]; then
            echo "Action error is not 'Path is a directory'"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Test - Extracting from an empty path
        id: extract-empty-path
        if: always()
        continue-on-error: true
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path:

      - name: Result - Extracting from an empty path
        id: extract-empty-path-result
        if: always()
        run: |
          echo "Action error is: '${{ steps.extract-empty-path.outputs.error }}'"
          if [[ "${{ steps.extract-empty-path.outputs.error }}" != "Path is required" ]]; then
            echo "Action error is not 'Path is required'"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Test - Extracting from a path with spaces
        id: extract-path-with-spaces
        if: always()
        continue-on-error: true
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: '  '

      - name: Result - Extracting from a path with spaces
        id: extract-path-with-spaces-result
        if: always()
        run: |
          echo "Action error is: '${{ steps.extract-empty-path.outputs.error }}'"
          if [[ "${{ steps.extract-empty-path.outputs.error }}" != "Path is required" ]]; then
            echo "Action error is not 'Path is required'"
            exit 1
          else
            echo "Test successful"
          fi

      - name: Summary
        if: always()
        run: |
          bash ./.github/actions/gen-test-summary-md.sh \
            "extract-data-string-from-file" \
            "Extracting a single word from a file" \
            ${{ steps.extract-data-single-word-result.outcome }} \
            "Extracting multiple words from a file" \
            ${{ steps.extract-data-multiple-words-result.outcome }} \
            "Extracting multiple lines from a file" \
            ${{ steps.extract-data-multiple-lines-result.outcome }} \
            "Extracting an empty file" \
            ${{ steps.extract-data-empty-result.outcome }} \
            "Extracting a file with spaces" \
            ${{ steps.extract-data-spaces-result.outcome }} \
            "Extracting from a non-existent file" \
            ${{ steps.extract-non-existent-file-result.outcome }} \
            "Extracting from a directory" \
            ${{ steps.extract-directory-result.outcome }} \
            "Extracting from an empty path" \
            ${{ steps.extract-empty-path-result.outcome }} \
            "Extracting from a path with spaces" \
            ${{ steps.extract-path-with-spaces-result.outcome }}


  test-extract-data-string-from-file-matrix:
    name: Test extract-data-string-from-file action
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    #env:
      #TESTING_MODE: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Extracting a single word from a file"
            path: ./.github/actions/extract-data-string-from-file/test/single-word
            expected_outcome: "success"
            expected_data: "foo"
            expected_error: ""
          - name: "Extracting multiple words from a file"
            path: ./.github/actions/extract-data-string-from-file/test/multiple-words
            expected_outcome: "success"
            expected_data: "foo bar"
            expected_error: ""
          - name: "Extracting multiple lines from a file"
            path: ./.github/actions/extract-data-string-from-file/test/multiple-lines
            expected_outcome: "success"
            expected_data: "foo\nbar"
            expected_error: ""
          - name: "Extracting an empty file"
            path: ./.github/actions/extract-data-string-from-file/test/empty
            expected_outcome: "success"
            expected_data: ""
            expected_error: ""
          - name: "Extracting a file with spaces"
            path: ./.github/actions/extract-data-string-from-file/test/spaces
            expected_outcome: "success"
            expected_data: ""
            expected_error: ""
          - name: "Extracting from a non-existent file"
            path: ./.github/actions/extract-data-string-from-file/test/non-existent
            expected_outcome: "failure"
            expected_data: ""
            expected_error: "Path does not exist"
          - name: "Extracting from a directory"
            path: ./.github/actions/extract-data-string-from-file/test/test
            expected_outcome: "failure"
            expected_data: ""
            expected_error: "Path is a directory"
          - name: "Extracting from an empty path"
            path: 
            expected_outcome: "failure"
            expected_data: ""
            expected_error: "Path is required"
          - name: "Extracting from a path with spaces"
            path: '  '
            expected_outcome: "failure"
            expected_data: ""
            expected_error: "Path is required"
    outputs:
      name: ${{ matrix.name }}
      result: ${{ steps.validate-test.outputs.result }}

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Test - ${{ matrix.name }}
        continue-on-error: true
        id: extract-data
        if: always()
        uses: ./.github/actions/extract-data-string-from-file
        with:
          path: ${{ matrix.path }}

      - name: Validate - ${{ matrix.name }}
        id: validate-test
        if: always()
        run: |
          bash ./.github/actions/extract-data-string-from-file/validate-tests.sh \
            "${{ matrix.name }}" \
            "${{ matrix.expected_outcome }}" \
            "${{ matrix.expected_data }}" \
            "${{ matrix.expected_error }}" \
            "${{ steps.extract-data.outputs.success }}" \
            "${{ steps.extract-data.outputs.data }}" \
            "${{ steps.extract-data.outputs.error }}"

      - name: Upload test result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-result-${{ strategy.job-index }}
          path: test-results/

      - name: Mark as failed
        if: ${{ steps.validate-test.outputs.result == 'false' }}
        run: |
          echo "Marking job as failed due to test failure"
          exit 1

  Summary:
    needs: test-extract-data-string-from-file-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-result-*
          merge-multiple: true
          path: test-results

      - name: Summarize all test results
        if: always()
        env:
          TESTING_MODE: true
        run: |
          echo "### Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY

          total_tests=0
          passed_tests=0
          
          for result_file in test-results/*.json; do
            if [[ -f "$result_file" ]]; then
              name=$(jq -r '.name' "$result_file")
              result=$(jq -r '.result' "$result_file")
              
              total_tests=$((total_tests + 1))
              
              if [[ "$result" == "true" ]]; then
                echo "| $name | ✅ PASS |" >> $GITHUB_STEP_SUMMARY
                passed_tests=$((passed_tests + 1))
              else
                echo "| $name | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $passed_tests/$total_tests tests passed" >> $GITHUB_STEP_SUMMARY

      - name: Delete artifacts after processing
        uses: geekyeggo/delete-artifact@v5
        with:
          name: test-result-*
          useGlob: true
          failOnError: false

########################################
########################################
########################################

# Test install-built-dependency action

# Need to check what happens if the path is empty
# Need to check what happens if the cache cannot be found
# Need to check what happens is the script cannot be found
# Need to check what happens if the script fails

########################################
########################################
########################################

# Test start-msys2=with-deps action

# Need to check what happens if the path is empty
# Need to check what happens if the path cannot be found
# Need to compare a clean install with one that has added dependencies
# Need to check what happens with multiple dependencies
# Need to check what happens with a group dependency

########################################
########################################
########################################
